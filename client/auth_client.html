<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Sign Up</title>

    <!-- ‚úÖ Load Supabase SDK First -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        .container {
            width: 350px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .message {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Login / Sign Up</h2>

        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">

        <button onclick="signUp()">Sign Up</button>
        <button onclick="login()">Login</button>

        <p class="message" id="statusMessage"></p>
    </div>

    <div class="container">
        <h2>Test MBTI Analysis</h2>
        <button onclick="testMBTIAnalysis()">Run MBTI Analysis</button>
        <p class="message" id="mbtiResponse"></p>
    </div>

    <div class="container">
        <h2>Test OCEAN Analysis</h2>
        <button onclick="testOCEANAnalysis()">Run OCEAN Analysis</button>
        <p class="message" id="oceanResponse"></p>
    </div>

    <!-- ‚úÖ Ensure this script runs after Supabase SDK is loaded -->
<script>
    let supabase;

    async function loadConfig() {
        try {
            console.log("üîÑ Fetching Supabase config...");

            let response = await fetch("http://localhost:8000/config");
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            let config = await response.json();

            if (!config.SUPABASE_URL || !config.SUPABASE_KEY) {
                throw new Error("‚ùå Missing Supabase credentials from backend.");
            }

            // ‚úÖ Initialize Supabase Client
            supabase = window.supabase.createClient(config.SUPABASE_URL, config.SUPABASE_KEY);
            console.log("‚úÖ Supabase Initialized Successfully:", supabase);

            // ‚úÖ Check if Auth module is available
            if (!supabase.auth) {
                throw new Error("‚ùå Supabase Auth module is missing!");
            }

        } catch (error) {
            console.error("‚ùå Error initializing Supabase:", error);
        }
    }

    async function signUp() {
        if (!supabase) {
            console.error("‚ùå Supabase is not initialized yet.");
            return;
        }

        let email = document.getElementById("email").value;
        let password = document.getElementById("password").value;

        let { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            document.getElementById("statusMessage").innerText = "Error: " + error.message;
        } else {
            document.getElementById("statusMessage").innerText = "‚úÖ Sign-up successful! Check your email.";
        }
    }

    async function login() {
        if (!supabase) {
            console.error("‚ùå Supabase is not initialized yet.");
            return;
        }

        let email = document.getElementById("email").value;
        let password = document.getElementById("password").value;

        let { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            document.getElementById("statusMessage").innerText = "Error: " + error.message;
        } else {
            localStorage.setItem("authToken", data.session.access_token);
            document.getElementById("statusMessage").innerText = "‚úÖ Login successful!";
        }
    }

    // ‚úÖ Ensure Supabase is initialized before allowing login/signup
    window.addEventListener("load", async () => {
        await loadConfig();
    });

    async function getAuthToken() {
        const { data, error } = await supabase.auth.getSession();
        if (error || !data.session) {
            console.error("‚ùå User is not authenticated:", error);
            document.getElementById("apiResponse").innerText = "Error: Please log in first.";
            return null;
        }
        return data.session.access_token;
    }


     // ‚úÖ Function to test MBTI analysis endpoint
        async function testMBTIAnalysis() {
            let token = await getAuthToken();
            if (!token) return;

            try {
                let response = await fetch("http://localhost:8000/mbti/mbti-analyze", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        user_id: "your_user_id",
                        message: "I enjoy deep conversations but also need time alone to recharge."
                    })
                });

                let result = await response.json();
                console.log("üîπ MBTI Analysis Response:", result);
                document.getElementById("mbtiResponse").innerText = JSON.stringify(result, null, 2);

            } catch (err) {
                console.error("‚ùå Error calling MBTI analysis:", err);
                document.getElementById("mbtiResponse").innerText = "Error accessing MBTI analysis.";
            }
        }

        // ‚úÖ Function to test OCEAN analysis endpoint
        async function testOCEANAnalysis() {
            let token = await getAuthToken();
            if (!token) return;

            try {
                let response = await fetch("http://localhost:8000/ocean/ocean-analyze", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        user_id: "your_user_id",
                        message: "I prefer structure and organization, but I also value creativity."
                    })
                });

                let result = await response.json();
                console.log("üîπ OCEAN Analysis Response:", result);
                document.getElementById("oceanResponse").innerText = JSON.stringify(result, null, 2);

            } catch (err) {
                console.error("‚ùå Error calling OCEAN analysis:", err);
                document.getElementById("oceanResponse").innerText = "Error accessing OCEAN analysis.";
            }
        }


</script>


</body>

</html>